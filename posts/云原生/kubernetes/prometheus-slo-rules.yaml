# Prometheus SLO Rules Generated by Sloth
# 由 Sloth 生成的 Prometheus SLO 规则文件
# 使用命令: sloth generate -i k8s-apiserver-slo-sloth.yaml -o prometheus-slo-rules.yaml

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: k8s-apiserver-slo-rules
  namespace: monitoring
  labels:
    app: sloth
    sloth_service: k8s-apiserver
spec:
  groups:
    # ApiServer 可用性 SLO 规则
    - name: sloth-slo-sli-recordings-k8s-apiserver-apiserver-availability
      interval: 30s
      rules:
        - record: slo:sli_error:ratio_rate5m
          expr: |
            (
              sum(rate(apiserver_request_total{code=~"5..",cluster=~".*"}[5m])) by (cluster)
            ) /
            (
              sum(rate(apiserver_request_total{cluster=~".*"}[5m])) by (cluster)
            )
          labels:
            sloth_id: k8s-apiserver-apiserver-availability
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-availability
            sloth_window: 5m

        - record: slo:sli_error:ratio_rate30m
          expr: |
            (
              sum(rate(apiserver_request_total{code=~"5..",cluster=~".*"}[30m])) by (cluster)
            ) /
            (
              sum(rate(apiserver_request_total{cluster=~".*"}[30m])) by (cluster)
            )
          labels:
            sloth_id: k8s-apiserver-apiserver-availability
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-availability
            sloth_window: 30m

        - record: slo:sli_error:ratio_rate1h
          expr: |
            (
              sum(rate(apiserver_request_total{code=~"5..",cluster=~".*"}[1h])) by (cluster)
            ) /
            (
              sum(rate(apiserver_request_total{cluster=~".*"}[1h])) by (cluster)
            )
          labels:
            sloth_id: k8s-apiserver-apiserver-availability
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-availability
            sloth_window: 1h

        - record: slo:sli_error:ratio_rate6h
          expr: |
            (
              sum(rate(apiserver_request_total{code=~"5..",cluster=~".*"}[6h])) by (cluster)
            ) /
            (
              sum(rate(apiserver_request_total{cluster=~".*"}[6h])) by (cluster)
            )
          labels:
            sloth_id: k8s-apiserver-apiserver-availability
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-availability
            sloth_window: 6h

        - record: slo:sli_error:ratio_rate1d
          expr: |
            (
              sum(rate(apiserver_request_total{code=~"5..",cluster=~".*"}[1d])) by (cluster)
            ) /
            (
              sum(rate(apiserver_request_total{cluster=~".*"}[1d])) by (cluster)
            )
          labels:
            sloth_id: k8s-apiserver-apiserver-availability
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-availability
            sloth_window: 1d

        - record: slo:sli_error:ratio_rate3d
          expr: |
            (
              sum(rate(apiserver_request_total{code=~"5..",cluster=~".*"}[3d])) by (cluster)
            ) /
            (
              sum(rate(apiserver_request_total{cluster=~".*"}[3d])) by (cluster)
            )
          labels:
            sloth_id: k8s-apiserver-apiserver-availability
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-availability
            sloth_window: 3d

        - record: slo:sli_error:ratio_rate30d
          expr: |
            (
              sum(rate(apiserver_request_total{code=~"5..",cluster=~".*"}[30d])) by (cluster)
            ) /
            (
              sum(rate(apiserver_request_total{cluster=~".*"}[30d])) by (cluster)
            )
          labels:
            sloth_id: k8s-apiserver-apiserver-availability
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-availability
            sloth_window: 30d

    # ApiServer 延迟 SLO 规则
    - name: sloth-slo-sli-recordings-k8s-apiserver-apiserver-latency
      interval: 30s
      rules:
        - record: slo:sli_error:ratio_rate5m
          expr: |
            1 - (
              (
                sum(rate(apiserver_request_duration_seconds_bucket{le="1",cluster=~".*"}[5m])) by (cluster)
              ) /
              (
                sum(rate(apiserver_request_duration_seconds_count{cluster=~".*"}[5m])) by (cluster)
              )
            )
          labels:
            sloth_id: k8s-apiserver-apiserver-latency
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-latency
            sloth_window: 5m

        - record: slo:sli_error:ratio_rate30m
          expr: |
            1 - (
              (
                sum(rate(apiserver_request_duration_seconds_bucket{le="1",cluster=~".*"}[30m])) by (cluster)
              ) /
              (
                sum(rate(apiserver_request_duration_seconds_count{cluster=~".*"}[30m])) by (cluster)
              )
            )
          labels:
            sloth_id: k8s-apiserver-apiserver-latency
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-latency
            sloth_window: 30m

        - record: slo:sli_error:ratio_rate1h
          expr: |
            1 - (
              (
                sum(rate(apiserver_request_duration_seconds_bucket{le="1",cluster=~".*"}[1h])) by (cluster)
              ) /
              (
                sum(rate(apiserver_request_duration_seconds_count{cluster=~".*"}[1h])) by (cluster)
              )
            )
          labels:
            sloth_id: k8s-apiserver-apiserver-latency
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-latency
            sloth_window: 1h

        - record: slo:sli_error:ratio_rate6h
          expr: |
            1 - (
              (
                sum(rate(apiserver_request_duration_seconds_bucket{le="1",cluster=~".*"}[6h])) by (cluster)
              ) /
              (
                sum(rate(apiserver_request_duration_seconds_count{cluster=~".*"}[6h])) by (cluster)
              )
            )
          labels:
            sloth_id: k8s-apiserver-apiserver-latency
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-latency
            sloth_window: 6h

        - record: slo:sli_error:ratio_rate1d
          expr: |
            1 - (
              (
                sum(rate(apiserver_request_duration_seconds_bucket{le="1",cluster=~".*"}[1d])) by (cluster)
              ) /
              (
                sum(rate(apiserver_request_duration_seconds_count{cluster=~".*"}[1d])) by (cluster)
              )
            )
          labels:
            sloth_id: k8s-apiserver-apiserver-latency
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-latency
            sloth_window: 1d

        - record: slo:sli_error:ratio_rate3d
          expr: |
            1 - (
              (
                sum(rate(apiserver_request_duration_seconds_bucket{le="1",cluster=~".*"}[3d])) by (cluster)
              ) /
              (
                sum(rate(apiserver_request_duration_seconds_count{cluster=~".*"}[3d])) by (cluster)
              )
            )
          labels:
            sloth_id: k8s-apiserver-apiserver-latency
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-latency
            sloth_window: 3d

        - record: slo:sli_error:ratio_rate30d
          expr: |
            1 - (
              (
                sum(rate(apiserver_request_duration_seconds_bucket{le="1",cluster=~".*"}[30d])) by (cluster)
              ) /
              (
                sum(rate(apiserver_request_duration_seconds_count{cluster=~".*"}[30d])) by (cluster)
              )
            )
          labels:
            sloth_id: k8s-apiserver-apiserver-latency
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-latency
            sloth_window: 30d

    # SLO 元数据和错误预算规则
    - name: sloth-slo-meta-recordings-k8s-apiserver
      interval: 30s
      rules:
        - record: slo:objective:ratio
          expr: vector(0.999)
          labels:
            sloth_id: k8s-apiserver-apiserver-availability
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-availability

        - record: slo:objective:ratio
          expr: vector(0.99)
          labels:
            sloth_id: k8s-apiserver-apiserver-latency
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-latency

        - record: slo:objective:ratio
          expr: vector(0.995)
          labels:
            sloth_id: k8s-apiserver-apiserver-read-latency
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-read-latency

        - record: slo:objective:ratio
          expr: vector(0.99)
          labels:
            sloth_id: k8s-apiserver-apiserver-write-latency
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-write-latency

        - record: slo:objective:ratio
          expr: vector(0.999)
          labels:
            sloth_id: k8s-apiserver-apiserver-error-rate
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-error-rate

        # 错误预算规则
        - record: slo:error_budget:ratio
          expr: |
            1 - (
              slo:sli_error:ratio_rate30d{sloth_service="k8s-apiserver"} /
              (1 - slo:objective:ratio{sloth_service="k8s-apiserver"})
            )
          labels:
            sloth_service: k8s-apiserver

    # 告警规则
    - name: sloth-slo-alerts-k8s-apiserver
      rules:
        # 快速燃尽告警 (2% 预算在 1 小时内消耗)
        - alert: K8sApiServerAvailabilityFastBurn
          expr: |
            (
              slo:sli_error:ratio_rate5m{sloth_id="k8s-apiserver-apiserver-availability"} > (14.4 * (1 - 0.999))
              and
              slo:sli_error:ratio_rate1h{sloth_id="k8s-apiserver-apiserver-availability"} > (14.4 * (1 - 0.999))
            )
          for: 2m
          labels:
            severity: critical
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-availability
            category: availability
          annotations:
            summary: "Kubernetes ApiServer availability fast burn"
            description: "High error rate is burning the error budget too fast for cluster {{ $labels.cluster }}"
            runbook_url: "https://runbooks.example.com/k8s-apiserver-availability"

        # 慢速燃尽告警 (5% 预算在 6 小时内消耗)
        - alert: K8sApiServerAvailabilitySlowBurn
          expr: |
            (
              slo:sli_error:ratio_rate30m{sloth_id="k8s-apiserver-apiserver-availability"} > (6 * (1 - 0.999))
              and
              slo:sli_error:ratio_rate6h{sloth_id="k8s-apiserver-apiserver-availability"} > (6 * (1 - 0.999))
            )
          for: 15m
          labels:
            severity: warning
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-availability
            category: availability
          annotations:
            summary: "Kubernetes ApiServer availability slow burn"
            description: "Error rate is burning the error budget for cluster {{ $labels.cluster }}"
            runbook_url: "https://runbooks.example.com/k8s-apiserver-availability"

        # 延迟快速燃尽告警
        - alert: K8sApiServerLatencyFastBurn
          expr: |
            (
              slo:sli_error:ratio_rate5m{sloth_id="k8s-apiserver-apiserver-latency"} > (14.4 * (1 - 0.99))
              and
              slo:sli_error:ratio_rate1h{sloth_id="k8s-apiserver-apiserver-latency"} > (14.4 * (1 - 0.99))
            )
          for: 2m
          labels:
            severity: critical
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-latency
            category: latency
          annotations:
            summary: "Kubernetes ApiServer latency fast burn"
            description: "High latency is burning the error budget too fast for cluster {{ $labels.cluster }}"
            runbook_url: "https://runbooks.example.com/k8s-apiserver-latency"

        # 延迟慢速燃尽告警
        - alert: K8sApiServerLatencySlowBurn
          expr: |
            (
              slo:sli_error:ratio_rate30m{sloth_id="k8s-apiserver-apiserver-latency"} > (6 * (1 - 0.99))
              and
              slo:sli_error:ratio_rate6h{sloth_id="k8s-apiserver-apiserver-latency"} > (6 * (1 - 0.99))
            )
          for: 15m
          labels:
            severity: warning
            sloth_service: k8s-apiserver
            sloth_slo: apiserver-latency
            category: latency
          annotations:
            summary: "Kubernetes ApiServer latency slow burn"
            description: "Latency is burning the error budget for cluster {{ $labels.cluster }}"
            runbook_url: "https://runbooks.example.com/k8s-apiserver-latency"

        # 错误预算耗尽告警
        - alert: K8sApiServerErrorBudgetExhausted
          expr: |
            slo:error_budget:ratio{sloth_service="k8s-apiserver"} < 0.1
          for: 5m
          labels:
            severity: critical
            sloth_service: k8s-apiserver
          annotations:
            summary: "Kubernetes ApiServer error budget exhausted"
            description: "Error budget for {{ $labels.sloth_slo }} in cluster {{ $labels.cluster }} is below 10%"
            runbook_url: "https://runbooks.example.com/k8s-apiserver-error-budget"

        # SLO 违反告警
        - alert: K8sApiServerSLOViolation
          expr: |
            slo:sli_error:ratio_rate5m{sloth_service="k8s-apiserver"} > 
            (1 - slo:objective:ratio{sloth_service="k8s-apiserver"})
          for: 10m
          labels:
            severity: warning
            sloth_service: k8s-apiserver
          annotations:
            summary: "Kubernetes ApiServer SLO violation"
            description: "SLO {{ $labels.sloth_slo }} is being violated in cluster {{ $labels.cluster }}"
            runbook_url: "https://runbooks.example.com/k8s-apiserver-slo-violation"